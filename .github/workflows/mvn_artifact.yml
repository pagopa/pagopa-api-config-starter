# This workflow will build a package using Maven and then publish it to GitHub packages when a release is created

name: Maven Package

on:
  release:
    types: [created]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'maven'

      - name: Build with Maven
        run: mvn -B package --file pom.xml

#      - name: Create Maven settings file
#        uses: whelk-io/maven-settings-xml-action@v20
#        with:
#          repositories: >
#            [
#              {
#                "id": "github",
#                "url": "https://maven.pkg.github.com/pagopa/pagopa-api-config-starter"
#              }
#            ]
#          servers: >
#            [
#              {
#                "id": "github",
#                "password": "${{github.token}}"
#              }
#            ]
#          output_file: /root/.m2/settings.xml
#
#      - name: DEBUG
#        run: |
#          cat settings.xml
#          echo '${{ toJSON(github) }}'

#      - name: Deploy to GitHub Package Registry
#        run: |
#          REPO="gh::default::https://maven.pkg.github.com/${{github.repository}}"
#          echo '$REPO'
#          mvn deploy -DaltReleaseDeploymentRepository="${REPO}" -DaltSnapshotDeploymentRepository="${REPO}"

      - name: Deploy to GitHub Package Registry
        run: |
          mkdir -p ~/.m2
          echo "<settings><servers><server><id>github</id><password>\${github.token}</password></server></servers></settings>" > ~/.m2/settings.xml
          REPO="gh::default::https://maven.pkg.github.com/${{github.repository}}"
          echo '$REPO'
          mvn deploy -DaltReleaseDeploymentRepository="${REPO}" -DaltSnapshotDeploymentRepository="${REPO}"

#        env:
#          PAT: ${{ secrets.API_GITHUB_TOKEN }}
#        run: |
#          mkdir -p ~/.m2
#          echo "PAT $PAT"
#          echo "<settings><servers><server><id>github</id><password>\${PAT}</password></server></servers></settings>" > ~/.m2/settings.xml
#          cat ~/.m2/settings.xml
#          REPO="gh::default::https://maven.pkg.github.com/pagopa/pagopa-api-config-starter"
#          mvn deploy -DaltReleaseDeploymentRepository="${REPO}" -DaltSnapshotDeploymentRepository="${REPO}"

